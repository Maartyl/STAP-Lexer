<style type='text/css'>.ptt15, .ptt10, .ptt11 {color: orange;}</style><code><span class='ptt6'>#</span> <span class='ptt2'>!/</span> <span class='ptt1'>usr</span> <span class='ptt2'>/</span> <span class='ptt1'>bin</span> <span class='ptt2'>/</span> <span class='ptt1'>env</span> <span class='ptt1'>coffee</span> <span class='ptt1'>file</span> <span class='ptt2'>=</span> <span class='ptt1'>process</span> <span class='ptt2'>.</span> <span class='ptt1'>argv</span> <span class='ptt121'>[</span> <span class='ptt201'>2</span> <span class='ptt122'>]</span> <span class='ptt2'>?</span> <span class='ptt6'>'</span> <span class='ptt1'>STAP</span> <span class='ptt2'></span> <span class='ptt1'>Highlight</span> <span class='ptt2'>.</span> <span class='ptt1'>coffee</span> <span class='ptt2'>'</span> <span class='ptt1'>fs</span> <span class='ptt2'>=</span> <span class='ptt1'>require</span> <span class='ptt6'>'</span> <span class='ptt1'>fs</span> <span class='ptt2'>'</span> <span class='ptt1'>style</span> <span class='ptt2'>=</span> <span class='ptt10'>"</span> <span class='ptt11'>"</span> <span class='ptt10'>"</span> <span class='ptt15'>





</span> <span class='ptt11'>"</span> <span class='ptt10'>"</span> <span class='ptt11'>"</span> <span class='ptt1'>save</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>data</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>fs</span> <span class='ptt2'>.</span> <span class='ptt1'>writeFile</span> <span class='ptt1'>file</span> <span class='ptt2'>+</span> <span class='ptt6'>'</span> <span class='ptt2'>.</span> <span class='ptt1'>html</span> <span class='ptt2'>'</span> <span class='ptt1'>data</span> <span class='ptt111'>(</span> <span class='ptt1'>err</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>console</span> <span class='ptt2'>.</span> <span class='ptt1'>log</span> <span class='ptt111'>(</span> <span class='ptt1'>err</span> <span class='ptt112'>)</span> <span class='ptt1'>if</span> <span class='ptt1'>err</span> <span class='ptt1'>parse</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>str</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>arr</span> <span class='ptt2'>=</span> <span class='ptt1'>str</span> <span class='ptt2'>.</span> <span class='ptt1'>split</span> <span class='ptt6'>'</span> <span class='ptt51'>\</span> <span class='ptt1'>x1E</span> <span class='ptt2'>'</span> <span class='ptt1'>arr</span> <span class='ptt2'>=</span> <span class='ptt1'>arr</span> <span class='ptt2'>.</span> <span class='ptt1'>filter</span> <span class='ptt111'>(</span> <span class='ptt1'>part</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>part</span> <span class='ptt2'>!=</span> <span class='ptt6'>'</span> <span class='ptt51'>\</span> <span class='ptt1'>n</span> <span class='ptt2'>'</span> <span class='ptt6'>#</span> <span class='ptt1'>hard</span> <span class='ptt1'>way</span> <span class='ptt1'>to</span> <span class='ptt1'>remove</span> <span class='ptt1'>last</span> <span class='ptt1'>elem</span> <span class='ptt1'>arr</span> <span class='ptt2'>.</span> <span class='ptt1'>map</span> <span class='ptt111'>(</span> <span class='ptt1'>val</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>splited</span> <span class='ptt2'>=</span> <span class='ptt1'>val</span> <span class='ptt2'>.</span> <span class='ptt1'>split</span> <span class='ptt6'>'</span> <span class='ptt2'>|</span> <span class='ptt2'>'</span> <span class='ptt201'>2</span> <span class='ptt1'>a</span> <span class='ptt2'>=</span> <span class='ptt1'>splited</span> <span class='ptt121'>[</span> <span class='ptt201'>0</span> <span class='ptt122'>]</span> <span class='ptt2'>.</span> <span class='ptt1'>split</span> <span class='ptt2'>'</span> <span class='ptt2'>'</span> <span class='ptt6'>#</span> <span class='ptt1'>pos</span> <span class='ptt1'>len</span> <span class='ptt1'>row</span> <span class='ptt1'>col</span> <span class='ptt1'>type</span> <span class='ptt1'>type</span> <span class='ptt2'>:</span> <span class='ptt1'>a</span> <span class='ptt121'>[</span> <span class='ptt201'>4</span> <span class='ptt122'>]</span> <span class='ptt1'>pos</span> <span class='ptt2'>:</span> <span class='ptt1'>a</span> <span class='ptt121'>[</span> <span class='ptt201'>0</span> <span class='ptt122'>]</span> <span class='ptt1'>len</span> <span class='ptt2'>:</span> <span class='ptt1'>a</span> <span class='ptt121'>[</span> <span class='ptt201'>1</span> <span class='ptt122'>]</span> <span class='ptt1'>row</span> <span class='ptt2'>:</span> <span class='ptt1'>a</span> <span class='ptt121'>[</span> <span class='ptt201'>2</span> <span class='ptt122'>]</span> <span class='ptt1'>col</span> <span class='ptt2'>:</span> <span class='ptt1'>a</span> <span class='ptt121'>[</span> <span class='ptt201'>3</span> <span class='ptt122'>]</span> <span class='ptt1'>data</span> <span class='ptt2'>:</span> <span class='ptt1'>splited</span> <span class='ptt121'>[</span> <span class='ptt201'>1</span> <span class='ptt122'>]</span> <span class='ptt1'>to_tag</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>type</span> <span class='ptt1'>content</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>if</span> <span class='ptt1'>type</span> <span class='ptt2'>==</span> <span class='ptt201'>1</span> <span class='ptt1'>then</span> <span class='ptt10'>"</span> <span class='ptt11'>"</span> <span class='ptt1'>else</span> <span class='ptt10'>"</span> <span class='ptt15'><span class='ptt#{type}'>#{content}</span> </span> <span class='ptt11'>"</span> <span class='ptt1'>taggify</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>arr</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>arr</span> <span class='ptt2'>.</span> <span class='ptt1'>map</span> <span class='ptt111'>(</span> <span class='ptt1'>val</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>to_tag</span> <span class='ptt1'>val</span> <span class='ptt2'>.</span> <span class='ptt1'>type</span> <span class='ptt1'>source</span> <span class='ptt2'>.</span> <span class='ptt1'>substr</span> <span class='ptt111'>(</span> <span class='ptt1'>val</span> <span class='ptt2'>.</span> <span class='ptt1'>pos</span> <span class='ptt1'>val</span> <span class='ptt2'>.</span> <span class='ptt1'>len</span> <span class='ptt112'>)</span> <span class='ptt1'>codify</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>code</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt10'>"</span> <span class='ptt15'><style type='text/css'>.ptt15, .ptt10, .ptt11 {color: orange;}</style><code>#{code}</code></span> <span class='ptt11'>"</span> <span class='ptt1'>merge</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>arr</span> <span class='ptt1'>src</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>source</span> <span class='ptt2'>=</span> <span class='ptt1'>src</span> <span class='ptt1'>offs</span> <span class='ptt2'>=</span> <span class='ptt201'>0</span> <span class='ptt6'>#</span> <span class='ptt1'>offset</span> <span class='ptt1'>arr</span> <span class='ptt2'>.</span> <span class='ptt1'>forEach</span> <span class='ptt111'>(</span> <span class='ptt1'>tkn</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>pos</span> <span class='ptt2'>=</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>pos</span> <span class='ptt2'>+</span> <span class='ptt1'>offs</span> <span class='ptt1'>len</span> <span class='ptt2'>=</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>len</span> <span class='ptt1'>orig</span> <span class='ptt2'>=</span> <span class='ptt1'>source</span> <span class='ptt2'>.</span> <span class='ptt1'>substr</span> <span class='ptt111'>(</span> <span class='ptt1'>pos</span> <span class='ptt1'>len</span> <span class='ptt112'>)</span> <span class='ptt1'>tag</span> <span class='ptt2'>=</span> <span class='ptt1'>to_tag</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>type</span> <span class='ptt1'>orig</span> <span class='ptt1'>source</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>source</span> <span class='ptt2'>.</span> <span class='ptt1'>substr</span> <span class='ptt201'>0</span> <span class='ptt1'>pos</span> <span class='ptt112'>)</span> <span class='ptt2'>+</span> <span class='ptt1'>tag</span> <span class='ptt2'>+</span> <span class='ptt111'>(</span> <span class='ptt1'>source</span> <span class='ptt2'>.</span> <span class='ptt1'>substr</span> <span class='ptt111'>(</span> <span class='ptt1'>pos</span> <span class='ptt2'>+</span> <span class='ptt1'>len</span> <span class='ptt112'>)</span> <span class='ptt112'>)</span> <span class='ptt1'>offs</span> <span class='ptt2'>+=</span> <span class='ptt111'>(</span> <span class='ptt1'>tag</span> <span class='ptt2'>.</span> <span class='ptt1'>length</span> <span class='ptt2'></span> <span class='ptt1'>orig</span> <span class='ptt2'>.</span> <span class='ptt1'>length</span> <span class='ptt112'>)</span> <span class='ptt1'>console</span> <span class='ptt2'>.</span> <span class='ptt1'>log</span> <span class='ptt10'>"</span> <span class='ptt15'>tag #{tag.length} - orig #{orig.length}: #{tag.length - orig.length}</span> <span class='ptt11'>"</span> <span class='ptt1'>source</span> <span class='ptt1'>merge2</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>arr</span> <span class='ptt1'>src</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>source</span> <span class='ptt2'>=</span> <span class='ptt1'>src</span> <span class='ptt1'>newarr</span> <span class='ptt2'>=</span> <span class='ptt121'>[</span> <span class='ptt122'>]</span> <span class='ptt6'>#</span> <span class='ptt1'>arr</span> <span class='ptt1'>to</span> <span class='ptt1'>append</span> <span class='ptt1'>to</span> <span class='ptt1'>last</span> <span class='ptt2'>=</span> <span class='ptt201'>0</span> <span class='ptt1'>arr</span> <span class='ptt2'>.</span> <span class='ptt1'>forEach</span> <span class='ptt111'>(</span> <span class='ptt1'>tkn</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>pos</span> <span class='ptt2'>=</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>pos</span> <span class='ptt1'>len</span> <span class='ptt2'>=</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>len</span> <span class='ptt6'>#</span> <span class='ptt1'>if</span> <span class='ptt111'>(</span> <span class='ptt1'>last</span> <span class='ptt2'><</span> <span class='ptt1'>pos</span> <span class='ptt112'>)</span> <span class='ptt6'>#</span> <span class='ptt1'>newarr</span> <span class='ptt2'>.</span> <span class='ptt1'>push</span> <span class='ptt111'>(</span> <span class='ptt1'>to_tag</span> <span class='ptt201'>0</span> <span class='ptt111'>(</span> <span class='ptt1'>src</span> <span class='ptt2'>.</span> <span class='ptt1'>substring</span> <span class='ptt1'>last</span> <span class='ptt1'>pos</span> <span class='ptt112'>)</span> <span class='ptt112'>)</span> <span class='ptt1'>newarr</span> <span class='ptt2'>.</span> <span class='ptt1'>push</span> <span class='ptt111'>(</span> <span class='ptt1'>to_tag</span> <span class='ptt1'>tkn</span> <span class='ptt2'>.</span> <span class='ptt1'>type</span> <span class='ptt111'>(</span> <span class='ptt1'>src</span> <span class='ptt2'>.</span> <span class='ptt1'>substr</span> <span class='ptt1'>pos</span> <span class='ptt1'>len</span> <span class='ptt112'>)</span> <span class='ptt112'>)</span> <span class='ptt1'>last</span> <span class='ptt2'>=</span> <span class='ptt1'>pos</span> <span class='ptt2'>+</span> <span class='ptt1'>len</span> <span class='ptt201'>1</span> <span class='ptt1'>newarr</span> <span class='ptt2'>.</span> <span class='ptt1'>join</span> <span class='ptt6'>'</span> <span class='ptt2'>'</span> <span class='ptt1'>lexer</span> <span class='ptt2'>=</span> <span class='ptt111'>(</span> <span class='ptt1'>require</span> <span class='ptt6'>'</span> <span class='ptt1'>child_process</span> <span class='ptt6'>'</span> <span class='ptt112'>)</span> <span class='ptt2'>.</span> <span class='ptt1'>spawn</span> <span class='ptt6'>'</span> <span class='ptt2'>./</span> <span class='ptt1'>stap</span> <span class='ptt2'></span> <span class='ptt1'>lex</span> <span class='ptt2'>'</span> <span class='ptt1'>source</span> <span class='ptt2'>=</span> <span class='ptt10'>"</span> <span class='ptt11'>"</span> <span class='ptt6'>#</span> <span class='ptt1'>original</span> <span class='ptt1'>source</span> <span class='ptt1'>file</span> <span class='ptt1'>buff</span> <span class='ptt2'>=</span> <span class='ptt10'>"</span> <span class='ptt11'>"</span> <span class='ptt6'>#</span> <span class='ptt1'>is</span> <span class='ptt1'>being</span> <span class='ptt1'>read</span> <span class='ptt1'>by</span> <span class='ptt1'>chunks</span> <span class='ptt1'>could</span> <span class='ptt1'>be</span> <span class='ptt1'>problem</span> <span class='ptt1'>in</span> <span class='ptt1'>split</span> <span class='ptt6'>#</span> <span class='ptt1'>lexer</span> <span class='ptt1'>events</span> <span class='ptt1'>lexer</span> <span class='ptt2'>.</span> <span class='ptt1'>stdout</span> <span class='ptt2'>.</span> <span class='ptt1'>setEncoding</span> <span class='ptt6'>'</span> <span class='ptt1'>utf</span> <span class='ptt201'>8</span> <span class='ptt2'>'</span> <span class='ptt1'>lexer</span> <span class='ptt2'>.</span> <span class='ptt1'>stdout</span> <span class='ptt2'>.</span> <span class='ptt1'>on</span> <span class='ptt6'>'</span> <span class='ptt1'>data</span> <span class='ptt2'>'</span> <span class='ptt111'>(</span> <span class='ptt1'>data</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>buff</span> <span class='ptt2'>+=</span> <span class='ptt1'>data</span> <span class='ptt1'>lexer</span> <span class='ptt2'>.</span> <span class='ptt1'>on</span> <span class='ptt6'>'</span> <span class='ptt1'>close</span> <span class='ptt2'>'</span> <span class='ptt2'>></span> <span class='ptt1'>out</span> <span class='ptt2'>=</span> <span class='ptt1'>merge2</span> <span class='ptt1'>parse</span> <span class='ptt111'>(</span> <span class='ptt1'>buff</span> <span class='ptt112'>)</span> <span class='ptt1'>source</span> <span class='ptt1'>console</span> <span class='ptt2'>.</span> <span class='ptt1'>log</span> <span class='ptt1'>out</span> <span class='ptt1'>save</span> <span class='ptt1'>codify</span> <span class='ptt1'>out</span> <span class='ptt1'>fs</span> <span class='ptt2'>.</span> <span class='ptt1'>readFile</span> <span class='ptt1'>file</span> <span class='ptt6'>'</span> <span class='ptt1'>utf</span> <span class='ptt201'>8</span> <span class='ptt2'>'</span> <span class='ptt111'>(</span> <span class='ptt1'>err</span> <span class='ptt1'>data</span> <span class='ptt112'>)</span> <span class='ptt2'>></span> <span class='ptt1'>console</span> <span class='ptt2'>.</span> <span class='ptt1'>log</span> <span class='ptt111'>(</span> <span class='ptt1'>err</span> <span class='ptt112'>)</span> <span class='ptt1'>if</span> <span class='ptt1'>err</span> <span class='ptt1'>source</span> <span class='ptt2'>=</span> <span class='ptt1'>data</span> <span class='ptt1'>lexer</span> <span class='ptt2'>.</span> <span class='ptt1'>stdin</span> <span class='ptt2'>.</span> <span class='ptt1'>end</span> <span class='ptt1'>data</span> <span class='ptt-1'></span> </code>